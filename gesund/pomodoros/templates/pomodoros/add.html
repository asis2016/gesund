{% extends 'base.html' %}
{% load static %}

{% block main %}

<!--    {% include './pomodoro-js.html' %}-->

<div class="container-fluid" id="weight-container">

    <div class="row">
        <div class="col">

            <div class="Timer"></div>

        </div>
    </div>


    <div class="row">
        <div class="col-lg-12">
            <div class="col-page-header">
                <h2>Pomodoros</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item active" aria-current="page">
                            Add pomodoro
                        </li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header card-header-menu">
                    Add pomodoro
                </div>
                <form method="POST">
                    <div class="card-body">
                        {% csrf_token %}
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            {{ form.errors }}
                        </div>
                        {% endif %}
                        <!-- datestamp -->
                        <div class="form-group row">
                            <label class="col-sm-4 col-form-label" for="id_datestamp">
                                Datestamp
                            </label>
                            <div class="col-sm-6">
                                <input autocomplete="off"
                                       class="form-control"
                                       id="id_datestamp"
                                       name="datestamp"
                                       placeholder="2022-01-23"
                                       required
                                       type="text">
                            </div>
                        </div>
                        <!-- pomodoro in minutes -->
                        <div class="form-group row mt-3">
                            <label class="col-sm-4 col-form-label"
                                   for="id_pomodoro_minutes">
                                Pomodoro (in minutes) taken
                            </label>
                            <div class="col-sm-6">
                                <input autocomplete="off"
                                       class="form-control"
                                       id="id_pomodoro_minutes"
                                       name="pomodoro_minutes"
                                       placeholder="1.0"
                                       type="number"
                                       required
                                       step="any">
                            </div>
                        </div>
                        <!-- breaks in minutes -->
                        <div class="form-group row mt-3">
                            <label class="col-sm-4 col-form-label"
                                   for="id_break_minutes">
                                Break (in minutes) taken
                            </label>
                            <div class="col-sm-6">
                                <input autocomplete="off"
                                       class="form-control"
                                       id="id_break_minutes"
                                       name="break_minutes"
                                       placeholder="1.0"
                                       type="number"
                                       required
                                       step="any">
                            </div>
                        </div>
                        <!-- remarks -->
                        <div class="form-group row mt-3">
                            <label class="col-sm-4 col-form-label"
                                   for="id_remarks">
                                Remarks
                            </label>
                            <div class="col-sm-6">
                                    <textarea class="form-control"
                                              name="remarks"
                                              cols="40" rows="10" id="id_remarks"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <button class="btn btn-secondary" type="submit">
                            <i class="fa-solid fa-floppy-disk"></i>
                            <span class="p-2">Save changes</span>
                        </button>
                        <a class="float-end" href="{% url 'pomodoros-index' %}">
                            Go back to the pomodoro list
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock main %}

{% block scripts %}

<script>
    let start = new Date;

    setInterval(function() {
    $('.Timer').text((new Date - start) / 1000 + " Seconds");
    }, 1000);
</script>

<script>
    // Credit: Mateusz Rybczonec

    const FULL_DASH_ARRAY = 283;
    const WARNING_THRESHOLD = 10;
    const ALERT_THRESHOLD = 5;

    const COLOR_CODES = {
        info: {
            color: "green"
        },
        warning: {
            color: "orange",
            threshold: WARNING_THRESHOLD
        },
        alert: {
            color: "red",
            threshold: ALERT_THRESHOLD
        }
    };

    const green = "green";

    const TIME_LIMIT = 2; // 25 minutes = 1500 seconds
    let timePassed = 0;
    let timeLeft = TIME_LIMIT;
    let timerInterval = null;
    let remainingPathColor = COLOR_CODES.info.color;

    /**
     * Main
     * */
    $("#app").html(`<div class="base-timer">
                        <svg class="base-timer__svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                            <g class="base-timer__circle">
                            <circle class="base-timer__path-elapsed" cx="50" cy="50" r="45"></circle>
                            <path id="base-timer-path-remaining" stroke-dasharray="283"
                                    class="base-timer__path-remaining ${green}"
                                    d="M 50, 50
                                      m -45, 0
                                      a 45,45 0 1,0 90,0
                                      a 45,45 0 1,0 -90,0">
                            </path>
                            </g>
                        </svg>
                          <span id="base-timer-label" class="base-timer__label">
                            ${formatTime(timeLeft)}
                          </span>
                        </div>`);

    /***
     *
     */
    $("#start").click(function () {
        console.log('started');
        console.log(this.text)
        startTimer(TIME_LIMIT);
    });

    function onTimesUp() {
        console.log('times up!');
        clearInterval(timerInterval);
        $("#base-timer-label").html(formatTime(TIME_LIMIT));
        // Now save pomodoro!
    }

    function startTimer(limit) {
        timerInterval = setInterval(() => {
            timePassed = timePassed += 1;
            timeLeft = limit - timePassed;
            $("#base-timer-label").html(formatTime(timeLeft));
            setCircleDasharray();
            setRemainingPathColor(timeLeft);

            if (timeLeft === 0) {
                onTimesUp();
            }
        }, 1000);
    }

    /**
     * format time.
     * */
    function formatTime(time) {
        const minutes = Math.floor(time / 60);
        let seconds = time % 60;

        if (seconds < 10) {
            seconds = `0${seconds}`;
        }

        return `${minutes}:${seconds}`;
    }

    function setRemainingPathColor(timeLeft) {
        const {alert, warning, info} = COLOR_CODES;
        if (timeLeft <= alert.threshold) {
            document
                .getElementById("base-timer-path-remaining")
                .classList.remove(warning.color);
            document
                .getElementById("base-timer-path-remaining")
                .classList.add(alert.color);
        } else if (timeLeft <= warning.threshold) {
            document
                .getElementById("base-timer-path-remaining")
                .classList.remove(info.color);
            document
                .getElementById("base-timer-path-remaining")
                .classList.add(warning.color);
        }
    }

    function calculateTimeFraction() {
        const rawTimeFraction = timeLeft / TIME_LIMIT;
        return rawTimeFraction - (1 / TIME_LIMIT) * (1 - rawTimeFraction);
    }

    function setCircleDasharray() {
        const circleDasharray = `${(calculateTimeFraction() * FULL_DASH_ARRAY).toFixed(0)} 283`;
        $("#base-timer-path-remaining").attr("stroke-dasharray", circleDasharray);
    }
</script>

{% endblock scripts %}