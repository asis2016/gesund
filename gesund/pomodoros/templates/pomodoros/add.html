{% extends 'base.html' %}
{% load static %}

{% block main %}
    {# todo: #}
    <style>
        .col-page-header i {
            font-size: 1rem;
        }
    </style>
    <div class="container-fluid pomodoro-container-add" id="pomodoro-container">
        <div class="row">
            <div class="col-lg-12">
                <div class="col-page-header">
                    <h2>
                        Pomodoro
                        <span class="modal-info" data-toggle="modal" data-target="#pomodoro-info-modal">
                            <i class="fa-solid fa-circle-info"></i>

                    </h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="#">Pomodoro</a></li>
                            <li class="breadcrumb-item active" aria-current="page">
                                Add pomodoro
                            </li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6 mt-4">

                <div class="pomodoro-alert">
                </div>

                <div class="card pomodoro-card">
                    <div class="card-header card-header-menu">
                        Add your pomodoro
                    </div>
                    <div class="card-body">
                        <div>
                            {% csrf_token %}
                            <div id="main" class="mb-3">
                                <div id="countdown"></div>
                            </div>
                            <button id="start" class="btn">
                                <i class="fa-solid fa-play"></i>
                            </button>
                            <button id="pause" class="btn" disabled>
                                <i class="fa-solid fa-pause"></i>
                            </button>
                            <button id="stop" class="btn" disabled>
                                <i class="fa-solid fa-stop"></i>
                            </button>
                        </div>

                    </div>
                    <div class="card-footer">
                        <!-- go back -->
                        <a class="float-end go-back-to-list go-back-lg"
                           href="{% url 'pomodoro-index' %}">
                            Go back to the pomodoro list
                        </a>
                        <a class="btn btn-secondary go-back-sm"
                           href="{% url 'pomodoro-index' %}">
                            <i class="fa-solid fa-angle-left"></i>
                            <span class="p-2">Go back</span>
                        </a>
                        <!-- go back ends -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade"
         id="pomodoro-info-modal"
         tabindex="-1"
         role="dialog"
         aria-labelledby="pomodoro-info-modal"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                        What is Pomodoro?
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/34/Il_pomodoro.jpg/220px-Il_pomodoro.jpg"
                             alt="">
                    </p>
                    <p>
                        The Pomodoro Technique is a time management method developed by Francesco Cirillo in the late
                        1980s.
                    </p>
                    <p>
                        It uses a kitchen timer to break work into intervals, typically 25 minutes in length, separated
                        by short breaks. Each interval is known as a pomodoro, from the Italian word for tomato, after
                        the tomato-shaped kitchen timer Cirillo used as a university student.
                    </p>
                </div>
            </div>
        </div>
    </div>
{% endblock main %}

{% block scripts %}
    <script>
        const GIVEN_TIME = "0:05";
        const TOKEN = "{{ TOKEN }}"
        const REST_API_URL = "{{ REST_API_URL }}"
        const UID = "{{ UID }}"
        const AUDIO = "/static/audio/timer.mp3"


        let csrf_token = $("[name='csrfmiddlewaretoken']").attr("value")
        let isPaused = false
        let isStartEnabled = true
        let isPauseEnabled = false
        let isStopEnabled = false

        $("#countdown").html(GIVEN_TIME)

        /**
         * Pomodoro alert
         * */
        const pomodoroAlert = (status) => {
            let alertStatus
            let msg

            if (status === "start") {
                alertStatus = "alert-info"
                msg = "Pomodoro started! Focus on your task."
            }

            if (status === "success") {
                alertStatus = "alert-success"
                msg = "Nice! One pomodoro completed."
            }

            let _html = `<div class="alert ${alertStatus} mt-3" role="alert"><p class="m-0">${msg}</p></div>`
            $(".pomodoro-alert").html(_html)
        }

        /**
         * Ringtone
         * */
        const playRingtone = () => {
            const audio = new Audio(AUDIO)
            audio.play()
        }

        /**
         * Save pomodoro
         * */
        const savePomodoro = () => {
            let settings = {
                "url": `${REST_API_URL}/pomodoro/`,
                "method": "POST",
                "timeout": 0,
                "headers": {
                    "Authorization": `Basic ${TOKEN}`,
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrf_token
                },
                "data": JSON.stringify({
                    "datestamp": get_today(),
                    "pomodoro": 1,
                    "short_break": 0,
                    "long_break": 0,
                    "remarks": "One pomodoro completed!",
                    "author": UID
                }),
            };

            $.ajax(settings).done(function () {
                pomodoroAlert('success')
            }).fail(function (jqXHR, textStatus) {
                console.log(`status: ${jqXHR.status} > ${jqXHR.statusText}`)
            })
        }

        /**
         * Get Pomodoro
         * */
        const getPomodoro = () => {
            var settings = {
                "url": `${REST_API_URL}/pomodoro/`,
                "method": "GET",
                "timeout": 0,
                "headers": {
                    "Authorization": `Basic ${TOKEN}`,
                },
            };

            $.ajax(settings).done(function (response) {
                console.log(response);
            });
        }

        /**
         * Start
         * */
        $("#start").click(function () {
            isStartEnabled = false
            $("#start").prop("disabled", true)

            if (!isPauseEnabled) {
                isPauseEnabled = true
                $("#pause").prop("disabled", false)
            }

            if (!isStopEnabled) {
                isStopEnabled = true
                $("#stop").prop("disabled", false)
            }

            (!isPaused) ? startTimer(GIVEN_TIME) : isPaused = false;
            pomodoroAlert('start')
        })

        /**
         * Pause
         * */
        $("#pause").click(function () {
            isPauseEnabled = false
            $("#pause").prop("disabled", true)

            if (!isStartEnabled) {
                isStartEnabled = true
                $("#start").prop("disabled", false)
            }

            isPaused = true;
        })

        /**
         * When timer is 00:00
         * */
        const endTimer = (minutes, seconds, interval) => {
            if (minutes == 0 && seconds == 0) {
                clearInterval(interval)

                if (!isStartEnabled) {
                    isStartEnabled = true
                    $("#start").prop("disabled", false)
                }

                if (isPauseEnabled) {
                    isPauseEnabled = false
                    $("#pause").prop("disabled", true)
                }

                if (isStopEnabled) {
                    isStopEnabled = false
                    $("#stop").prop("disabled", true)
                }

                playRingtone()
                savePomodoro()

                $("#countdown").html(GIVEN_TIME)
            }
        }

        /**
         * Start timer
         * */
        const startTimer = (timer2) => {
            let interval = setInterval(function () {

                if (!isPaused) {
                    let timer = timer2.split(":")

                    let minutes = parseInt(timer[0], 10)
                    let seconds = parseInt(timer[1], 10)

                    --seconds;

                    minutes = (seconds < 0) ? --minutes : minutes;

                    if (minutes < 0) clearInterval(interval)

                    seconds = (seconds < 0) ? 59 : seconds;
                    seconds = (seconds < 10) ? '0' + seconds : seconds;

                    $("#countdown").html(minutes + ':' + seconds)
                    timer2 = minutes + ':' + seconds;

                    endTimer(minutes, seconds, interval)
                }
            }, 1000)
        }

        /**
         * Stop
         * */
        $("#stop").click(function () {
            location.reload()
            //$(".pomodoro-alert").hide()
            /** console.log("stopped!")
             $("#countdown").html(GIVEN_TIME)
             clearInterval(interval)
             */
        })
    </script>
{% endblock scripts %}